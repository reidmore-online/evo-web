import IconButton from "<evo-icon-button>";
import FilterChip from "<evo-filter-chip>";
import Button, { type Input as ButtonInput } from "<evo-button>";
import { type Item, type Input as MenuInput } from "<evo-menu>";
export interface Input<
    Index extends number | string | (number | string)[] | undefined,
> extends Omit<MenuInput<Index>, "variant"> {
    open?: boolean;
    openChange?: (open: boolean) => void;
    collapseOnSelect?: boolean;
    prefixId?: string;
    variant?: "form" | "button" | "icon" | "filter";
    borderless?: boolean;
    partiallyDisabled?: ButtonInput["partiallyDisabled"];
    priority?: "primary" | "secondary" | "tertiary" | "delete" | "none";
    size?: ButtonInput["size"];
    transparent?: boolean;
    disabled?: boolean;
    split?: string;
    noToggleIcon?: boolean;
    label?: Marko.AttrTag<Marko.HTML.Span>;
    prefixLabel?: string;
    icon?: Marko.AttrTag<Marko.HTML.Span>;
    footerButton?: Marko.AttrTag<ButtonInput>;
    text?: string;
    reverse?: boolean;
    strategy?: "absolute" | "fixed";
    fixWidth?: boolean;
}
<const/{
    class: inputClass,
    text,
    icon,
    noToggleIcon: inputNoToggleIcon,
    reverse,
    strategy,
    fixWidth,
    borderless,
    size,
    partiallyDisabled,
    footerButton,
    priority: inputPriority,
    disabled,
    variant,
    item: items = [],
    label,
    selected: inputSelected,
    selectedChange,
    prefixLabel,
    prefixId,
    split: inputSplit,
    collapseOnSelect,
    transparent: inputTransparent,
    ...htmlInput
}=input>

<id/labelId>
<let/selected:=input.selected>
<let/open:=input.open>
<const/{
    tagName,
    transparent,
    isSelected,
    split,
    priority,
    noToggleIcon,
}=(() => {
    let priority = null;
    let split;
    let status;
    let noToggleIcon;
    let transparent;
    let tagName;
    let isSelected;

    if (variant === "icon") {
        tagName = IconButton;
        transparent = inputTransparent;
    } else if (variant === "filter") {
        tagName = FilterChip;
        isSelected = Array.isArray(selected)
            ? selected.length > 0
            : selected !== -1;
    } else {
        tagName = Button;
        split = inputSplit;
        noToggleIcon = inputNoToggleIcon;
        priority = inputPriority;
    }

    return {
        tagName,
        status,
        split,
        isSelected,
        noToggleIcon,
        transparent,
        priority,
    };
})()>
<id/menu>
<span/root ...htmlInput class=["menu-button", inputClass]>
    <evo-expander/expander
        open:=open
        reverse=reverse
        strategy=strategy
        collapseOnSelect=collapseOnSelect
        host=root
        overlay=() => {
            return document.getElementById(menu)!;
        }/>
    <${tagName}
        class=[`menu-button__button`]
        size=size
        priority=priority as ButtonInput["priority"]
        borderless=borderless
        variant=variant
        aria-haspopup="true"
        selected=isSelected
        transparent=transparent
        aria-expanded=expander.ariaExpanded
        aria-labelledby=labelId && `${prefixId} ${labelId}`
        split=split
        disabled=disabled
        partiallyDisabled=partiallyDisabled
        onClick(e, target) {
            expander.onClick();
            (input.onClick || null)?.(e, target);
        }>
        <if=label>
            <span ...label class=["menu-button-prefix-label", label.class]/>
            ${" "}
        </if>
        <span id=labelId>
            <${input.content}/>
        </span>
        <if=!noToggleIcon>
            <evo-icon-chevron-down-12/>
        </if>
    </>
    <evo-menu
        style=expander.floatingStyles
        id=menu
        selected:=input.selected
        classPrefix="menu-button"
        fixed=strategy === "fixed"
        variant=(variant as MenuInput<Index>["variant"])
        fixWidth=fixWidth
        tabindex=-1
        footerButton=footerButton
        item=items/>
</span>
